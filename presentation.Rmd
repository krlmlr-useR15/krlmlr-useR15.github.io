---
title: "Improving computational performance with algorithm engineering"
author: "Kirill MÃ¼ller"
date: "July 1, 2015"
output: ioslides_presentation
---

```{r echo=FALSE}
library(ggplot2)
set.seed(20150619L)
```

## Algorithm engineering

> Design, analysis, implementation, optimization, profiling and experimental evaluation of computer algorithms. (*Wikipedia*)

Here: Substitute existing implementation by an algorithm
with a lower computational complexity.


## Overview

1. Weighted random sampling without replacement
2. Similarity-based statistical matching
3. Management of package dependencies
4. Survey calibration


## Applications

Generation of input for agent-based microsimulation models

- Input: register data, demographic and mobility surveys
- *Survey calibration*: Compute weights
- *Sampling without replacement*: Transform to integer weights
- *Statistical matching*: Combine datasets
- (*Package dependencies*: Results from raw data)


## Random sampling

```{r}
sample.int
```

- `replace`: With or without replacement
- `prob`: Uniform or non-uniform probabilities


## Implementation of random sampling

Common framework:

- Subdivide an interval according to probabilities
- Uniformly sample point from interval
- Choose sub-interval covered by point
- If sampling without replacement, remove sub-interval

```{r echo=F}
interval_fig_height <- 0.6
ggplot_interval_base <-
  list(
    theme_classic(),
    theme(text = element_blank(), axis.line = element_blank(),
          axis.ticks = element_blank()),
    scale_color_identity(),
    theme(plot.margin = grid::unit(c(0,0,0,0), "line")),
    NULL
  )
ggplot_interval <-
  c(
    ggplot_interval_base,
    list(
      coord_flip(),
      NULL
    )
  )
ggplot_rainbow <-
  list(
    scale_fill_gradientn(colours = rainbow(23), guide = FALSE),
    NULL
  )
ggplot_interval_rainbow <-
  c(
    ggplot_interval,
    ggplot_rainbow
  )
```



## Implementation of random sampling

Common framework:

- **Subdivide an interval according to probabilities**
- Uniformly sample point from interval
- Choose sub-interval covered by point
- If sampling without replacement, remove sub-interval

```{r echo=FALSE, fig.height=interval_fig_height}
N <- 10
prob <- prop.table(runif(N))
d <- data.frame(y=prob, yy=1/N)
ggplot(d, aes(x=0, y=y, group=0)) +
  ggplot_interval +
  geom_bar(position="stack", stat="identity", fill=NA, color="black")
```




## Implementation of random sampling

Common framework:

- Subdivide an interval according to probabilities
- **Uniformly sample point from interval**
- Choose sub-interval covered by point
- If sampling without replacement, remove sub-interval

```{r echo=FALSE, fig.height=interval_fig_height}
yr <- runif(1)
d$r <- c(0, diff(cumsum(d$y) < yr))
ggplot(d, aes(x=0, y=y, group=0)) +
  ggplot_interval +
  geom_bar(position="stack", stat="identity", fill=NA, color="black") +
  geom_point(x=0, y=yr, color = "red")
```



## Implementation of random sampling

Common framework:

- Subdivide an interval according to probabilities
- Uniformly sample point from interval
- **Choose sub-interval covered by point**
- If sampling without replacement, remove sub-interval

```{r echo=FALSE, fig.height=interval_fig_height}
ggplot(d, aes(x=0, y=y, group=0)) +
  ggplot_interval +
  geom_bar(aes(fill=ifelse(r, "green", NA)), position="stack", stat="identity", color=NA) +
  geom_bar(position="stack", stat="identity", fill=NA, color="black") +
  scale_fill_identity() +
  geom_point(x=0, y=yr, color = "red")
```


## Random sampling with replacement

- No need to remove sub-interval
- Uniform probabilities: No need for explicit interval

```{r echo=FALSE, fig.height=interval_fig_height}
ggplot(d, aes(x=0, y=yy, group=0)) +
  ggplot_interval +
  geom_bar(position="stack", stat="identity", fill=NA, color="black") +
  scale_fill_identity()
```

- Nonuniform probabilities: Binary search?
    - Better: Walker's alias method (used in R for large number of not
  entirely unlikely elements)


```{r echo=FALSE, fig.height=interval_fig_height}
d$f <- seq_along(d$r)
ggplot(d, aes(x=0, y=y, group=0, fill=f)) +
  ggplot_interval_rainbow +
  geom_bar(position="stack", stat="identity", color="black")
```

```{r echo=FALSE, fig.height=interval_fig_height*2}
ggplot(d, aes(x=-order(y), y=y, group=f, fill=f)) +
  ggplot_interval_base +
  ggplot_rainbow +
  geom_bar(stat="identity", color="black") +
  geom_bar(aes(y=yy), position="stack", stat="identity", fill=NA, color="black", linetype=3)
```


## Random sampling without replacement

Common framework:

- Subdivide an interval according to probabilities
- Uniformly sample point from interval
- Choose sub-interval covered by point
- **If sampling without replacement, remove sub-interval**

```{r echo=FALSE, fig.height=interval_fig_height}
ggplot(d, aes(x=0, y=y, group=0, fill=ifelse(r, NA, f))) +
  ggplot_interval_rainbow +
  geom_bar(position="stack", stat="identity", color="black")
```


```{r echo=FALSE, fig.height=interval_fig_height}
ggplot(d[!d$r,], aes(x=0, y=y, group=0, fill=f)) +
  ggplot_interval_rainbow +
  geom_bar(position="stack", stat="identity", color="black")
```
